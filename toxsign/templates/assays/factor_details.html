{% extends "base.html" %}
{% load static i18n %}
{% load custom %}

{% block content %}
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>
<link href="{% static 'css/graph.css' %}" rel="stylesheet">
<script src="{% static 'js/graph.js' %}"></script>
<script src="{% static 'js/context-menu.js' %}"></script>
    <div class="container">
      <div class="tab-content card" style="text-align:center;">
        <div class="tab-pane active text-style card-body">
          <div id='graph'></div>
          <script>
            d3.json("{% url 'graph' %}?q={{project.tsx_id}}").then( function(json){
              drawGraph(json.data, json.max_parallel, json.max_depth, "{{factor.tsx_id}}");
            });
          </script>
        </div>
      </div>
      <br>
      <div class="row">
          <div class="col-md-12">
                <h2>{{ factor.tsx_id }} - {{ factor.name }} 
                
                {% if project.status == "PUBLIC" %}<span class="badge badge-pill badge-success">Public</span>{% endif %}
                {% if project.status == "PENDING" %}<span class="badge badge-pill badge-secondary">Pending</span>{% endif %}
                {% if project.status == "PRIVATE" %}<span class="badge badge-pill badge-dark">Private</span>{% endif %}
                {% if project.project_type == "INTERVENTIONAL" %} <span class="badge badge-primary">Interventional</span>{% endif %}
                {% if project.project_type == "OBSERVATIONAL" %} <span class="badge badge-success">Observational</span>{% endif %}
                {% if factor.chemical_subfactor_of.count > 1 %} <span class="badge badge-warning">Mixture</span>{% endif %}
                
                </h2>
                <hr>
          </div>
      </div>
      <div class="row">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a href="" data-target="#chemical" data-toggle="tab" class="nav-link active">Chemical ({{factor.chemical_subfactor_of.count}})</a>
            </li>
            <li class="nav-item">
                <a href="" data-target="#biological" data-toggle="tab" class="nav-link">Biological (soon)</a>
            </li>
            <li class="nav-item">
                <a href="" data-target="#physical" data-toggle="tab" class="nav-link">Physical (soon)</a>
            </li>
        </ul>
        <div class="tab-content p-b-3" style="margin-top:20px;">
            <div class="tab-pane active" id="chemical">
              {% if not factor.chemical_subfactor_of.count %}
                  <div class="row my-5">
                    <div class="col-md-8 mb-5">
                      <p>No chemical subfactors linked to this factor</p>
                    </div>
                  </div>
              {% endif %}
              {% for chemical in factor.chemical_subfactor_of.all %}
                <div class="row my-5">
                  <div class="col-md-8 mb-5">
                    <h2><i class="fas fa-flask"></i> Chemical factor nÂ° {{ forloop.counter }}</h2>
                    <table class="table">
                      <tbody>
                        <tr>
                          <th scope="row">Chemical</th> 
                          <td>{% if chemical.chemical %}{{chemical.chemical.name}}{% else %}{{chemical.chemical_slug}}{% endif %}</td>
                        </tr>
                        <tr>
                          <th scope="row">Route</th> 
                          <td>{% if chemical.route %}{{chemical.route}}{% else %} No route provided {% endif %}</td>
                        </tr>
                        <tr>
                          <th scope="row">Vehicule</th> 
                          <td>{% if chemical.route %}{{chemical.vehicule}}{% else %} No vehicule provided {% endif %}</td>
                        </tr>
                        <tr>
                          <th scope="row">Dose</th> 
                          <td>{% if chemical.dose_value %}{{chemical.dose_value}} {{chemical.dose_unit}}{% else %} No dose provided {% endif %}</td>
                        </tr>
                        <tr>
                          <th scope="row">Exposure time</th> 
                          <td>{% if chemical.exposure_time %}{{chemical.exposure_time}} hours {% else %} No exposure time provided {% endif %}</td>
                        </tr>
                        <tr>
                          <th scope="row">Exposure frequencies</th> 
                          <td>{% if chemical.exposure_frequencie %}{{chemical.exposure_frequencie}} {% else %} No exposure frequencies provided {% endif %}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="col-md-4 mb-5">
                    <h2>Additional information</h2>
                    <hr>
                    {% if chemical.additional_info %} {{ chemical.additional_info }} {% else %} No additional information provided {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="tab-pane" id="biological">
                <div class="row my-5">
                  <div class="col-md-12 mb-5">
                    <p>No biological subfactors linked to this factor</p>
                  </div>
                </div>
            </div>
            <div class="tab-pane" id="physical">
                <div class="row my-5">
                  <div class="col-md-12 mb-5">
                    <p>No physical subfactors linked to this factor</p>
                  </div>
                </div>
            </div>
        </div>
      </div>
      {% if project.created_by == request.user%}
        <div class="row my-5">
            <div class="col-md-8 mb-5">
                  <h2>Authorization</h2>
                  <table class="table">
                    </thead>
                    <tbody>
                      <tr>
                        <th scope="row">Read group</th>
                        <td>
                          {% for read in project.read_groups.all %}
                            <span>{{ read }}</span>
                          {% endfor %}
                        </td>
                      </tr>
                      <tr>
                        <th scope="row">Edit group</th>
                        <td>
                          {% for edit in project.edit_groups.all %}
                            <span>{{ edit }}</span>
                          {% endfor %}
                        </td>
                      </tr>
                    </tbody>
                  </table>
            </div>
            <div class="col-md-4 mb-5">
                  <h2>Information</h2>
                  <table class="table">
                    </thead>
                    <tbody>
                      <tr>
                        <th scope="row">Owner</th>
                        <td>{% show_username factor %}</td>
                      </tr>
                      <tr>
                        <th scope="row">Creation date</th>
                        <td>{{ factor.created_at }}</td>
                      </tr>
                      <tr>
                        <th scope="row">Last update</th>
                        <td>{{ factor.updated_at }}</td>
                      </tr>
                    </tbody>
                  </table>
            </div>
        </div>
      {% endif %}


    <div class="modal fade" id="modal-group">
        <div class="modal-dialog modal-lg">
            <div class="modal-content"></div>
        </div>
    </div>

{% endblock %}

{% for chemical in factor.chemical_subfactor_of.all %}
      <p><b>Chemical</b> {% if chemical.chemical %}{{chemical.chemical.name}}{% else %}{{chemical.chemical_slug}}{% endif %}</p><br>
      <p><b>Route</b> : {{chemical.route}} <b>Vehicule</b> : {{chemical.vehicule}}</p><br>
      <p><b>Dose</b> : {{chemical.dose_value}} {{chemical.dose_unit}}</p>
      {% if can_edit %}
      <div class="float-right">
      <a role="button" href="{% url 'assays:chemical_subfactor_edit' chemical.id %}" class="btn btn-info"><i class="fas fa-edit"></i></a>
      <a role="button" href="{% url 'assays:subfactor_delete' 'chemical' chemical.id %}" onclick="return confirm('Are you sure you want to delete this subfactor?');" class="btn btn-danger"><i class="fas fa-trash"></i></a>
      </div>
      {% endif %}
      <br>
      <p><b>Exposure</b> : {{chemical.exposure_time}} {{chemical.exposure_frequencie}}</p><br>
      <p><b>Additional info</b> : {{chemical.additional_info}}</p><br>
      <hr>
  {% endfor %}
